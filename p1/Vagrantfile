
Vagrant.configure("2") do |config|
  vagrant_box = "ubuntu/jammy64"
  provider = "virtualbox"
  provision_server = <<-SHELL
    # Set the INSTALL_K3S_EXEC environment variable
    export INSTALL_K3S_EXEC="--bind-address 192.168.56.110 --flannel-iface eth1"
    curl -sfL https://get.k3s.io | sh -
    sleep 10
    cp /var/lib/rancher/k3s/server/node-token /vagrant/node-token
    echo "WE DID IT GUYS (delete, just for testing, ok?)"
  SHELL
  provision_server_worker = <<-SHELL
    while [ ! -f /vagrant/node-token ]; do
      echo "Waiting for token..."
      sleep 2
    done
    echo "provision_server_worker begins, master has finished, the servant debuts"
    export K3S_URL="https://192.168.56.110:6443"
    echo "after export K3S_URL=https://192.168.56.110:6443"
    export K3S_TOKEN=$(cat /vagrant/node-token)
    echo "after export K3S_TOKEN=$(cat /vagrant/node-token)"
    export INSTALL_K3S_EXEC="--node-ip 192.168.56.111 --flannel-iface enp0s8"
    curl -sfL https://get.k3s.io | sh -
    echo "It's time to sleep"
    sleep 10
    echo "WE DID IT AGAIN GUYS (delete, just for testing, ok?)"
  SHELL
  nodes = [
    {
      name: "npavelicS",
      IP_address: "192.168.56.110",
      CPU: 1,
      RAM: 512,
      provision: provision_server
    },
    {
      name: "kkwasnySW",
      IP_address: "192.168.56.111",
      CPU: 1,
      RAM: 512,
      provision: provision_server_worker
    }
  ]

  config.vm.box = vagrant_box

  nodes.each do |node|
    config.vm.define node[:name] do |control|
      control.vm.hostname = node[:name]
      control.vm.network "private_network", ip: node[:IP_address]
      control.vm.provider provider do |machine|
        machine.memory = node[:RAM]
        machine.cpus = node[:CPU]
      end
      control.vm.provision "shell", inline: node[:provision]
    end
  end
end